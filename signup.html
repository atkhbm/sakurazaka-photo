<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>新規登録 | 櫻坂46 生写真交換サイト</title>
  <style>
    body { font-family: 'Helvetica Neue', system-ui, -apple-system, Segoe UI, Roboto, 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', 'Yu Gothic', sans-serif; background:#f9f9fb; margin:0; color:#333; }
    header { background:#fff; display:flex; justify-content:space-between; align-items:center; padding:16px 20px; border-bottom:1px solid #ddd; }
    header h1 { margin:0; font-size:1.2rem; color:#c81d5f; }
    nav a { margin-left: 16px; text-decoration:none; color:#555; font-weight:bold; }
    nav a:hover { color:#c81d5f; }
    .wrap { max-width: 560px; margin: 32px auto; background:#fff; padding: 24px; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,.06); }
    h2 { margin-top:0; color:#333; }
    .grid { display:grid; gap:14px; }
    label { font-weight:bold; display:block; margin-bottom:6px; }
    input, select { width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:16px; }
    .row { display:grid; grid-template-columns: 1fr 160px; gap:10px; align-items:end; }
    .help { font-size:.85rem; color:#777; margin-top:4px; }
    .actions { margin-top:18px; display:flex; gap:12px; flex-wrap:wrap; }
    button, .link-btn { background:#c81d5f; color:#fff; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; font-weight:bold; text-decoration:none; display:inline-block; }
    button:hover, .link-btn:hover { background:#a9134a; }
    .error { margin-top:12px; color:#c0392b; font-weight:bold; }
    .note { margin-top:12px; font-size:.9rem; color:#555; }
  </style>
</head>
<body>
  <header>
    <h1>櫻坂46 生写真交換サイト</h1>
    <nav data-auth-links></nav>
  </header>

  <div class="wrap">
    <h2>新規登録</h2>

    <form id="signup-form" class="grid" novalidate>
      <div>
        <label for="displayName">ニックネーム</label>
        <input id="displayName" type="text" required maxlength="30" placeholder="例：りな推し" />
      </div>

      <div>
        <label for="email">メールアドレス</label>
        <input id="email" type="email" required placeholder="you@example.com" autocomplete="username" />
      </div>

      <div>
        <label for="password">パスワード（8文字以上）</label>
        <input id="password" type="password" required minlength="8" placeholder="8文字以上" autocomplete="new-password" />
      </div>

      <!-- 任意：SNS情報 -->
      <div>
        <label for="xId">X（旧Twitter）ID <span class="help">任意。@は不要（例：sakurafan）</span></label>
        <div class="row">
          <input id="xId" type="text" inputmode="latin" placeholder="例：sakurafan" />
          <select id="xVis">
            <option value="match_only" selected>マッチ後のみ表示</option>
            <option value="public">常に表示</option>
            <option value="private">非公開</option>
          </select>
        </div>
      </div>

      <div>
        <label for="igId">Instagram ID <span class="help">任意。@は不要（例：sakura.fan）</span></label>
        <div class="row">
          <input id="igId" type="text" inputmode="latin" placeholder="例：sakura.fan" />
          <select id="igVis">
            <option value="match_only" selected>マッチ後のみ表示</option>
            <option value="public">常に表示</option>
            <option value="private">非公開</option>
          </select>
        </div>
      </div>

      <div class="actions">
        <button type="submit">登録する</button>
        <a class="link-btn" href="login.html">ログインへ</a>
      </div>

      <div id="error" class="error" aria-live="polite"></div>
      <p class="note">※開発中の仮アカウントはブラウザに保存されます。別端末・別ブラウザでは共有されません。</p>
    </form>
  </div>

  <!-- 認証ロジック -->
  <script src="auth.js"></script>
  <script>
    // ヘッダーのログイン/ログアウト出し分け
    if (typeof renderHeaderAuthLinks === "function") renderHeaderAuthLinks();

    // next= で登録後の遷移先を切り替え可能（例：signup.html?next=mypage.html）
    function getNextPath(defaultPath = "mypage.html") {
      const p = new URLSearchParams(location.search).get("next");
      if (!p) return defaultPath;
      if (/^\/[A-Za-z0-9/_\-.]+$/.test(p) || /^[A-Za-z0-9/_\-.]+$/.test(p)) return p;
      return defaultPath;
    }

    // 入力補助：@除去 & トリム
    function sanitizeId(v='') {
      return (v || '').replace(/^@+/, '').trim();
    }

    // バリデーション（簡易）
    function validateX(id) {
      if (!id) return true; // 任意
      // 英数とアンダースコアのみ、1-15
      return /^[A-Za-z0-9_]{1,15}$/.test(id);
    }
    function validateIG(id) {
      if (!id) return true; // 任意
      // 英数/ドット/アンダースコア、1-30
      return /^[A-Za-z0-9._]{1,30}$/.test(id);
    }

    // 既存auth.jsのユーザー配列にSNS情報を追記する
    function patchUserWithSNS(email, sns) {
      try {
        const LS_USERS = "app_users";
        const LS_SESSION = "app_session";
        const users = JSON.parse(localStorage.getItem(LS_USERS) || "[]");
        const idx = users.findIndex(u => (u.email || '').toLowerCase() === email.toLowerCase());
        if (idx >= 0) {
          users[idx].sns = sns;
          localStorage.setItem(LS_USERS, JSON.stringify(users));
        }
        // セッションは email/displayName のみ保存仕様だが、将来参照用に拡張したい場合はここで上書き可
        const session = JSON.parse(localStorage.getItem(LS_SESSION) || "null");
        if (session && (session.email || '').toLowerCase() === email.toLowerCase()) {
          // 必要なら session.sns = sns; を付与して setItem
          // 今回は最小構成で据え置き
        }
      } catch(e) {
        console.warn("SNS保存パッチに失敗:", e);
      }
    }

    const form = document.getElementById("signup-form");
    const displayNameEl = document.getElementById("displayName");
    const emailEl = document.getElementById("email");
    const passwordEl = document.getElementById("password");
    const xIdEl = document.getElementById("xId");
    const xVisEl = document.getElementById("xVis");
    const igIdEl = document.getElementById("igId");
    const igVisEl = document.getElementById("igVis");
    const errorEl = document.getElementById("error");
    let submitting = false;

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (submitting) return;
      submitting = true;

      errorEl.textContent = "";
      const btn = form.querySelector('button[type="submit"]');
      const original = btn.textContent;
      btn.disabled = true; btn.textContent = "登録中…";

      const displayName = displayNameEl.value.trim();
      const email = emailEl.value.trim();
      const password = passwordEl.value;

      // SNS整形
      const xId = sanitizeId(xIdEl.value);
      const igId = sanitizeId(igIdEl.value);

      try {
        if (!displayName) throw new Error("ニックネームを入力してください。");
        if (!/^\S+@\S+\.\S+$/.test(email)) throw new Error("メールアドレスの形式が正しくありません。");
        if (password.length < 8) throw new Error("パスワードは8文字以上にしてください。");
        if (!validateX(xId)) throw new Error("XのIDは英数・アンダースコアで1〜15文字にしてください（@不要）。");
        if (!validateIG(igId)) throw new Error("InstagramのIDは英数・ドット・アンダースコアで1〜30文字にしてください（@不要）。");

        // 1) auth.js でユーザー登録＆ログイン
        await signUp({ email, password, displayName });

        // 2) 登録直後にSNS情報をユーザーに追記（ローカル保存仕様）
        const sns = {
          x: { id: xId || "", visibility: xVisEl.value },           // "private" | "match_only" | "public"
          instagram: { id: igId || "", visibility: igVisEl.value }
        };
        patchUserWithSNS(email, sns);

        alert("登録が完了しました。マイページへ移動します。");
        location.href = getNextPath("mypage.html");
      } catch (err) {
        errorEl.textContent = err?.message || "登録に失敗しました。時間をおいて再度お試しください。";
        btn.disabled = false; btn.textContent = original;
        submitting = false;
      }
    });
  </script>
</body>
</html>

